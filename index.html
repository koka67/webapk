<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web APK - Direct Communication</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #e0f7ff 0%, #bbdefb 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 150, 0.15);
            overflow: hidden;
            border: 1px solid #e0f7fa;
        }
        
        header {
            background: linear-gradient(135deg, #42a5f5 0%, #1976d2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        
        .logo {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .logo i {
            margin-right: 10px;
            font-size: 32px;
        }
        
        .view-container {
            padding: 20px;
            min-height: 500px;
        }
        
        .login-form, .signup-form {
            max-width: 400px;
            margin: 0 auto;
            padding: 30px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 150, 0.1);
            background: linear-gradient(to bottom right, #e3f2fd, #f5fbff);
        }
        
        h2 {
            text-align: center;
            margin-bottom: 25px;
            color: #1976d2;
            position: relative;
            padding-bottom: 10px;
        }
        
        h2::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 3px;
            background: linear-gradient(to right, #42a5f5, #1976d2);
            border-radius: 3px;
        }
        
        .form-group {
            margin-bottom: 20px;
            position: relative;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #1976d2;
        }
        
        input {
            width: 100%;
            padding: 14px 14px 14px 40px;
            border: 1px solid #90caf9;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
            background-color: #f1f8ff;
        }
        
        input:focus {
            border-color: #42a5f5;
            box-shadow: 0 0 0 3px rgba(66, 165, 245, 0.2);
            outline: none;
        }
        
        .input-icon {
            position: absolute;
            left: 12px;
            top: 38px;
            color: #1976d2;
            font-size: 18px;
        }
        
        button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #42a5f5 0%, #1976d2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
            box-shadow: 0 4px 10px rgba(25, 118, 210, 0.2);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(25, 118, 210, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #ffd54f 0%, #ffb300 100%);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef5350 0%, #d32f2f 100%);
        }
        
        .user-status {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-online {
            background-color: #4CAF50;
            box-shadow: 0 0 8px #4CAF50;
        }
        
        .status-offline {
            background-color: #F44336;
        }
        
        .user-list {
            list-style: none;
            margin-top: 20px;
        }
        
        .user-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: 10px;
            margin-bottom: 12px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            transition: all 0.3s;
            cursor: pointer;
            background: linear-gradient(to right, #f5fbff, #ffffff);
        }
        
        .user-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .user-info {
            flex-grow: 1;
        }
        
        .user-actions {
            display: flex;
            gap: 10px;
        }
        
        .action-btn {
            width: auto;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .message-btn {
            background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%);
        }
        
        .call-btn {
            background: linear-gradient(135deg, #ff8a65 0%, #ff5722 100%);
        }
        
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 500px;
            border: 1px solid #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            background: white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .chat-header {
            background: linear-gradient(135deg, #42a5f5 0%, #1976d2 100%);
            color: white;
            padding: 15px;
            display: flex;
            align-items: center;
        }
        
        .chat-messages {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23e3f2fd" opacity="0.1"/></svg>');
            background-size: 30px 30px;
        }
        
        .message {
            max-width: 70%;
            padding: 12px 16px;
            margin-bottom: 15px;
            border-radius: 18px;
            position: relative;
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message-sent {
            align-self: flex-end;
            background: linear-gradient(135deg, #42a5f5 0%, #1976d2 100%);
            color: white;
            border-bottom-right-radius: 5px;
        }
        
        .message-received {
            align-self: flex-start;
            background: #f1f1f1;
            background: linear-gradient(to bottom right, #ffffff, #f1f8ff);
            border-bottom-left-radius: 5px;
            border: 1px solid #e3f2fd;
        }
        
        .message-sender {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 12px;
        }
        
        .chat-input {
            display: flex;
            padding: 15px;
            background: #f5f5f5;
            border-top: 1px solid #e0e0e0;
        }
        
        .chat-input input {
            flex-grow: 1;
            margin-right: 10px;
            border-radius: 20px;
            padding: 12px 20px;
        }
        
        .chat-input button {
            width: auto;
            border-radius: 20px;
            padding: 12px 25px;
        }
        
        .admin-panel {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            background: linear-gradient(to bottom right, #f5fbff, #ffffff);
        }
        
        .admin-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .user-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .user-table th, .user-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e3f2fd;
        }
        
        .user-table th {
            background-color: #e3f2fd;
            color: #1976d2;
            font-weight: 600;
        }
        
        .user-table tr:hover {
            background-color: #f5fbff;
        }
        
        .status-cell {
            display: flex;
            align-items: center;
        }
        
        .action-cell {
            display: flex;
            gap: 8px;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            color: #1976d2;
            font-size: 14px;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            margin-top: 20px;
            border-radius: 0 0 20px 20px;
            font-weight: 500;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: #4CAF50;
            color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transform: translateX(120%);
            transition: transform 0.3s ease-out;
            display: flex;
            align-items: center;
        }
        
        .notification i {
            margin-right: 10px;
            font-size: 20px;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.error {
            background: #F44336;
        }
        
        .back-btn {
            display: inline-block;
            margin-bottom: 15px;
            padding: 8px 15px;
            width: auto;
            background: #bdbdbd;
        }
        
        .hidden {
            display: none;
        }
        
        .app-icon {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .app-icon div {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #42a5f5 0%, #1976d2 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 40px;
            box-shadow: 0 5px 15px rgba(25, 118, 210, 0.3);
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #42a5f5 0%, #1976d2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 15px;
        }
        
        .call-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 400px;
            background: linear-gradient(135deg, #e0f7ff 0%, #bbdefb 100%);
            border-radius: 20px;
            margin-top: 20px;
            padding: 30px;
            text-align: center;
        }
        
        .call-icon {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
            color: white;
            font-size: 40px;
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }
        
        .call-actions {
            display: flex;
            gap: 20px;
            margin-top: 30px;
        }
        
        .call-btn-large {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        
        .call-accept {
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
        }
        
        .call-reject {
            background: linear-gradient(135deg, #F44336 0%, #C62828 100%);
        }
        
        .call-mute {
            background: linear-gradient(135deg, #FF9800 0%, #EF6C00 100%);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-comments"></i>
                <h1>Web APK - Direct Communication</h1>
            </div>
        </header>
        
        <div class="view-container">
            <!-- Login View -->
            <div id="login-view">
                <div class="app-icon">
                    <div><i class="fas fa-phone-alt"></i></div>
                </div>
                <div class="login-form">
                    <h2>User Login</h2>
                    <div class="form-group">
                        <label for="login-username">Username</label>
                        <i class="fas fa-user input-icon"></i>
                        <input type="text" id="login-username" placeholder="Enter your username">
                    </div>
                    <div class="form-group">
                        <label for="login-password">Password</label>
                        <i class="fas fa-lock input-icon"></i>
                        <input type="password" id="login-password" placeholder="Enter your password">
                    </div>
                    <button id="login-btn">Login</button>
                    <button id="signup-switch-btn" class="btn-secondary">Create New Account</button>
                </div>
            </div>
            
            <!-- Signup View -->
            <div id="signup-view" class="hidden">
                <button id="back-to-login" class="back-btn"><i class="fas fa-arrow-left"></i> Back to Login</button>
                <div class="signup-form">
                    <h2>Create New Account</h2>
                    <div class="form-group">
                        <label for="signup-username">Username</label>
                        <i class="fas fa-user input-icon"></i>
                        <input type="text" id="signup-username" placeholder="Choose a username">
                    </div>
                    <div class="form-group">
                        <label for="signup-password">Password</label>
                        <i class="fas fa-lock input-icon"></i>
                        <input type="password" id="signup-password" placeholder="Create a password">
                    </div>
                    <div class="form-group">
                        <label for="signup-confirm">Confirm Password</label>
                        <i class="fas fa-lock input-icon"></i>
                        <input type="password" id="signup-confirm" placeholder="Confirm your password">
                    </div>
                    <button id="signup-btn">Sign Up</button>
                    <div id="signup-message" style="margin-top: 15px; text-align: center;"></div>
                </div>
            </div>
            
            <!-- User Dashboard View -->
            <div id="dashboard-view" class="hidden">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <button id="logout-btn" class="back-btn"><i class="fas fa-arrow-left"></i> Logout</button>
                    <h2>Welcome, <span id="current-user"></span>!</h2>
                    <div id="user-status-indicator" class="user-status status-online"></div>
                </div>
                
                <div style="margin: 25px 0;">
                    <h3><i class="fas fa-users"></i> Online Users</h3>
                    <ul id="online-users-list" class="user-list"></ul>
                    
                    <h3 style="margin-top: 30px;"><i class="fas fa-user-friends"></i> All Users</h3>
                    <ul id="all-users-list" class="user-list"></ul>
                </div>
            </div>
            
            <!-- Chat View -->
            <div id="chat-view" class="hidden">
                <button id="back-to-dashboard" class="back-btn"><i class="fas fa-arrow-left"></i> Back to Dashboard</button>
                <div class="chat-container">
                    <div class="chat-header">
                        <div class="user-status status-online"></div>
                        <h3>Chat with <span id="chat-with-user">User</span></h3>
                    </div>
                    <div id="chat-messages" class="chat-messages">
                        <!-- Messages will appear here -->
                    </div>
                    <div class="chat-input">
                        <input type="text" id="message-input" placeholder="Type your message...">
                        <button id="send-message-btn"><i class="fas fa-paper-plane"></i> Send</button>
                    </div>
                </div>
            </div>
            
            <!-- Call View -->
            <div id="call-view" class="hidden">
                <button id="back-from-call" class="back-btn"><i class="fas fa-arrow-left"></i> Back</button>
                <div class="call-container">
                    <div class="call-icon">
                        <i class="fas fa-phone-alt"></i>
                    </div>
                    <h2>Calling <span id="call-with-user">User</span>...</h2>
                    <p>Connecting to user, please wait</p>
                    <div class="call-actions">
                        <div class="call-btn-large call-mute">
                            <i class="fas fa-microphone-slash"></i>
                        </div>
                        <div class="call-btn-large call-reject">
                            <i class="fas fa-phone-slash"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Admin Panel View -->
            <div id="admin-view" class="hidden">
                <button id="admin-logout-btn" class="back-btn"><i class="fas fa-arrow-left"></i> Logout</button>
                <h2><i class="fas fa-user-shield"></i> Admin Dashboard</h2>
                
                <div class="admin-panel">
                    <h3><i class="fas fa-user-plus"></i> Create New User</h3>
                    <div class="form-group">
                        <i class="fas fa-user input-icon"></i>
                        <input type="text" id="new-username" placeholder="Username">
                    </div>
                    <div class="form-group">
                        <i class="fas fa-lock input-icon"></i>
                        <input type="password" id="new-password" placeholder="Password">
                    </div>
                    <button id="create-user-btn"><i class="fas fa-plus-circle"></i> Create User</button>
                    
                    <h3 style="margin-top: 30px;"><i class="fas fa-users-cog"></i> User Management</h3>
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="admin-user-list">
                            <!-- User list will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="footer">
            Web APK created by Aung Thura
        </div>
    </div>
    
    <div id="notification" class="notification">
        <i class="fas fa-bell"></i>
        <span id="notification-message">New message received!</span>
    </div>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDEXAMPLE-1234567890",
            authDomain: "webapk-example.firebaseapp.com",
            databaseURL: "https://webapk-example-default-rtdb.firebaseio.com",
            projectId: "webapk-example",
            storageBucket: "webapk-example.appspot.com",
            messagingSenderId: "1234567890",
            appId: "1:1234567890:web:abcdef1234567890"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // Hardcoded accounts (stored in JavaScript, not in Firebase)
        const hardcodedAccounts = {
            // Admin accounts
            "admin": { 
                username: "admin", 
                password: "aungthura142492", 
                isAdmin: true,
                status: "offline",
                approved: true
            },
            "admin2": { 
                username: "admin2", 
                password: "247161", 
                isAdmin: true,
                status: "offline",
                approved: true
            },
            // Regular user accounts
            "user1": { 
                username: "user1", 
                password: "password1", 
                isAdmin: false,
                status: "offline",
                approved: true
            },
            "user2": { 
                username: "user2", 
                password: "password2", 
                isAdmin: false,
                status: "offline",
                approved: true
            }
        };
        
        // DOM Elements
        const views = {
            login: document.getElementById('login-view'),
            signup: document.getElementById('signup-view'),
            dashboard: document.getElementById('dashboard-view'),
            chat: document.getElementById('chat-view'),
            call: document.getElementById('call-view'),
            admin: document.getElementById('admin-view')
        };
        
        const loginUsername = document.getElementById('login-username');
        const loginPassword = document.getElementById('login-password');
        const loginBtn = document.getElementById('login-btn');
        const signupSwitchBtn = document.getElementById('signup-switch-btn');
        const backToLoginBtn = document.getElementById('back-to-login');
        const signupUsername = document.getElementById('signup-username');
        const signupPassword = document.getElementById('signup-password');
        const signupConfirm = document.getElementById('signup-confirm');
        const signupBtn = document.getElementById('signup-btn');
        const signupMessage = document.getElementById('signup-message');
        const logoutBtn = document.getElementById('logout-btn');
        const currentUserSpan = document.getElementById('current-user');
        const onlineUsersList = document.getElementById('online-users-list');
        const allUsersList = document.getElementById('all-users-list');
        const backToDashboardBtn = document.getElementById('back-to-dashboard');
        const chatWithUserSpan = document.getElementById('chat-with-user');
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendMessageBtn = document.getElementById('send-message-btn');
        const adminLogoutBtn = document.getElementById('admin-logout-btn');
        const newUsername = document.getElementById('new-username');
        const newPassword = document.getElementById('new-password');
        const createUserBtn = document.getElementById('create-user-btn');
        const adminUserList = document.getElementById('admin-user-list');
        const notification = document.getElementById('notification');
        const notificationMessage = document.getElementById('notification-message');
        const backFromCallBtn = document.getElementById('back-from-call');
        const callWithUserSpan = document.getElementById('call-with-user');
        
        // App state
        let currentUser = null;
        let currentChatWith = null;
        let allUsers = {...hardcodedAccounts};
        
        // Initialize Firebase database structure
        function initDatabase() {
            // Create initial structure for users if not exists
            database.ref('users').once('value').then(snapshot => {
                if (!snapshot.exists()) {
                    database.ref('users').set({});
                }
            });
        }
        
        // Show a specific view and hide others
        function showView(viewName) {
            Object.keys(views).forEach(view => {
                views[view].classList.toggle('hidden', view !== viewName);
            });
        }
        
        // Show notification
        function showNotification(message, isError = false) {
            notificationMessage.textContent = message;
            notification.classList.remove('error');
            if (isError) {
                notification.classList.add('error');
            }
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // Login function
        function login(username, password) {
            // First check if it's a hardcoded account
            if (hardcodedAccounts[username] && hardcodedAccounts[username].password === password) {
                const user = hardcodedAccounts[username];
                
                // Update user status to online
                user.status = "online";
                
                currentUser = {
                    id: username,
                    username: user.username,
                    isAdmin: user.isAdmin
                };
                
                // Show appropriate view
                if (user.isAdmin) {
                    showView('admin');
                    loadAdminUserList();
                } else {
                    currentUserSpan.textContent = user.username;
                    showView('dashboard');
                    loadUsers();
                }
                
                // Listen for new messages
                listenForMessages();
                
                return;
            }
            
            // Check Firebase for other users
            database.ref('users').once('value').then(snapshot => {
                const users = snapshot.val();
                let userFound = false;
                
                for (const userId in users) {
                    const user = users[userId];
                    if (user.username === username && user.password === password) {
                        userFound = true;
                        
                        if (!user.approved) {
                            showNotification('Your account is pending admin approval', true);
                            return;
                        }
                        
                        currentUser = {
                            id: userId,
                            username: user.username,
                            isAdmin: user.isAdmin || false
                        };
                        
                        // Update user status to online
                        database.ref('users/' + userId).update({
                            status: 'online'
                        });
                        
                        // Show appropriate view
                        if (user.isAdmin) {
                            showView('admin');
                            loadAdminUserList();
                        } else {
                            currentUserSpan.textContent = user.username;
                            showView('dashboard');
                            loadUsers();
                        }
                        
                        // Listen for new messages
                        listenForMessages();
                        
                        break;
                    }
                }
                
                if (!userFound) {
                    showNotification('Invalid username or password', true);
                }
            });
        }
        
        // Sign up function
        function signup(username, password) {
            // Check if username is a hardcoded account
            if (hardcodedAccounts[username]) {
                signupMessage.textContent = 'Username is reserved';
                signupMessage.style.color = '#F44336';
                return;
            }
            
            // Check if username already exists
            database.ref('users').once('value').then(snapshot => {
                const users = snapshot.val();
                let usernameExists = false;
                
                for (const userId in users) {
                    if (users[userId].username === username) {
                        usernameExists = true;
                        break;
                    }
                }
                
                if (usernameExists) {
                    signupMessage.textContent = 'Username already exists';
                    signupMessage.style.color = '#F44336';
                    return;
                }
                
                // Create new user (pending approval)
                const newUserRef = database.ref('users').push();
                newUserRef.set({
                    username: username,
                    password: password,
                    isAdmin: false,
                    status: 'offline',
                    approved: false
                });
                
                signupMessage.textContent = 'Account created! Waiting for admin approval.';
                signupMessage.style.color = '#4CAF50';
                
                // Clear form
                signupUsername.value = '';
                signupPassword.value = '';
                signupConfirm.value = '';
            });
        }
        
        // Load users for dashboard
        function loadUsers() {
            // Start with hardcoded users
            const usersList = Object.values(hardcodedAccounts)
                .filter(user => !user.isAdmin && user.approved);
                
            // Then add Firebase users
            database.ref('users').on('value', snapshot => {
                const firebaseUsers = snapshot.val() || {};
                
                // Combine hardcoded and Firebase users
                allUsers = {...hardcodedAccounts, ...firebaseUsers};
                
                onlineUsersList.innerHTML = '';
                allUsersList.innerHTML = '';
                
                // Add users to lists
                for (const userId in allUsers) {
                    const user = allUsers[userId];
                    
                    // Skip current user and non-approved users
                    if ((currentUser && userId === currentUser.id) || !user.approved) continue;
                    
                    // Skip admins in user view
                    if (user.isAdmin) continue;
                    
                    const userItem = document.createElement('li');
                    userItem.className = 'user-item';
                    userItem.dataset.userId = userId;
                    
                    const firstLetter = user.username.charAt(0).toUpperCase();
                    
                    userItem.innerHTML = `
                        <div class="user-avatar">${firstLetter}</div>
                        <div class="user-info">
                            <strong>${user.username}</strong>
                            <div>${user.status === 'online' ? 'Online' : 'Offline'}</div>
                        </div>
                        <div class="user-actions">
                            <button class="action-btn message-btn" onclick="startChat('${userId}', '${user.username}')">
                                <i class="fas fa-comment"></i> Message
                            </button>
                            <button class="action-btn call-btn" onclick="startCall('${userId}', '${user.username}')">
                                <i class="fas fa-phone"></i> Call
                            </button>
                        </div>
                    `;
                    
                    if (user.status === 'online') {
                        onlineUsersList.appendChild(userItem.cloneNode(true));
                    }
                    allUsersList.appendChild(userItem);
                }
            });
        }
        
        // Start chat with a user
        function startChat(userId, username) {
            currentChatWith = {
                id: userId,
                username: username
            };
            chatWithUserSpan.textContent = username;
            loadChatMessages();
            showView('chat');
        }
        
        // Load chat messages
        function loadChatMessages() {
            chatMessages.innerHTML = '';
            
            if (!currentUser || !currentChatWith) return;
            
            const chatId = [currentUser.id, currentChatWith.id].sort().join('_');
            database.ref('chats/' + chatId).on('value', snapshot => {
                chatMessages.innerHTML = '';
                
                if (snapshot.exists()) {
                    const messages = snapshot.val();
                    Object.keys(messages).forEach(messageId => {
                        const message = messages[messageId];
                        addMessageToChat(message.senderId, message.text, message.timestamp);
                    });
                }
                
                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
            });
        }
        
        // Add message to chat UI
        function addMessageToChat(senderId, text, timestamp) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${senderId === currentUser.id ? 'message-sent' : 'message-received'}`;
            
            const date = new Date(timestamp);
            const timeString = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            messageDiv.innerHTML = `
                <div class="message-sender">${senderId === currentUser.id ? 'You' : allUsers[senderId]?.username}</div>
                <div>${text}</div>
                <div style="text-align: right; font-size: 10px; margin-top: 5px;">${timeString}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
        }
        
        // Send message
        function sendMessage() {
            const message = messageInput.value.trim();
            if (!message || !currentChatWith) return;
            
            const chatId = [currentUser.id, currentChatWith.id].sort().join('_');
            const newMessageRef = database.ref('chats/' + chatId).push();
            
            newMessageRef.set({
                senderId: currentUser.id,
                text: message,
                timestamp: Date.now()
            });
            
            messageInput.value = '';
        }
        
        // Start call
        function startCall(userId, username) {
            callWithUserSpan.textContent = username;
            showView('call');
        }
        
        // Listen for new messages
        function listenForMessages() {
            database.ref('chats').on('child_added', snapshot => {
                const chatId = snapshot.key;
                const participants = chatId.split('_');
                
                if (participants.includes(currentUser.id)) {
                    database.ref('chats/' + chatId).limitToLast(1).on('child_added', messageSnapshot => {
                        const message = messageSnapshot.val();
                        
                        // Skip if message is from current user or we're in the chat view
                        if (message.senderId === currentUser.id || 
                            document.getElementById('chat-view').classList.contains('hidden') === false) {
                            return;
                        }
                        
                        const senderName = allUsers[message.senderId]?.username || 'Unknown';
                        showNotification(`New message from ${senderName}: ${message.text}`);
                    });
                }
            });
        }
        
        // Load admin user list
        function loadAdminUserList() {
            // Start with hardcoded users
            const hardcodedUserList = Object.entries(hardcodedAccounts)
                .filter(([_, user]) => !user.isAdmin)
                .map(([id, user]) => ({ id, ...user }));
                
            // Then add Firebase users
            database.ref('users').on('value', snapshot => {
                const firebaseUsers = snapshot.val() || {};
                adminUserList.innerHTML = '';
                
                // Combine all users
                const usersToDisplay = [...hardcodedUserList];
                
                for (const userId in firebaseUsers) {
                    const user = firebaseUsers[userId];
                    usersToDisplay.push({ id: userId, ...user });
                }
                
                // Add users to admin table
                for (const user of usersToDisplay) {
                    // Skip admins in the list
                    if (user.isAdmin) continue;
                    
                    const row = document.createElement('tr');
                    
                    const statusClass = user.status === 'online' ? 'status-online' : 'status-offline';
                    const statusText = user.status === 'online' ? 'Online' : 'Offline';
                    
                    row.innerHTML = `
                        <td>${user.username}</td>
                        <td class="status-cell">
                            <div class="user-status ${statusClass}"></div>
                            ${user.approved ? statusText : 'Pending Approval'}
                        </td>
                        <td class="action-cell">
                            ${user.approved ? 
                                `<button class="action-btn btn-danger" onclick="deactivateUser('${user.id}')">
                                    <i class="fas fa-ban"></i> Deactivate
                                </button>` : 
                                `<button class="action-btn btn-success" onclick="approveUser('${user.id}')">
                                    <i class="fas fa-check"></i> Approve
                                </button>`
                            }
                            ${user.id in hardcodedAccounts ? '' : 
                                `<button class="action-btn btn-danger" onclick="deleteUser('${user.id}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>`
                            }
                        </td>
                    `;
                    
                    adminUserList.appendChild(row);
                }
            });
        }
        
        // Create new user (admin function)
        function createUser() {
            const username = newUsername.value.trim();
            const password = newPassword.value.trim();
            
            if (!username || !password) {
                showNotification('Username and password are required', true);
                return;
            }
            
            // Check if username is a hardcoded account
            if (hardcodedAccounts[username]) {
                showNotification('Username is reserved', true);
                return;
            }
            
            // Check if username exists
            database.ref('users').once('value').then(snapshot => {
                const users = snapshot.val();
                let usernameExists = false;
                
                for (const userId in users) {
                    if (users[userId].username === username) {
                        usernameExists = true;
                        break;
                    }
                }
                
                if (usernameExists) {
                    showNotification('Username already exists', true);
                    return;
                }
                
                // Create new user
                const newUserRef = database.ref('users').push();
                newUserRef.set({
                    username: username,
                    password: password,
                    isAdmin: false,
                    status: 'offline',
                    approved: true
                });
                
                showNotification(`User ${username} created successfully`);
                
                // Clear form
                newUsername.value = '';
                newPassword.value = '';
            });
        }
        
        // Approve user (admin function)
        function approveUser(userId) {
            if (userId in hardcodedAccounts) {
                // Hardcoded users are always approved
                showNotification('User is already approved');
                return;
            }
            
            database.ref('users/' + userId).update({
                approved: true
            });
            showNotification('User approved');
        }
        
        // Deactivate user (admin function)
        function deactivateUser(userId) {
            if (userId in hardcodedAccounts) {
                showNotification('Cannot deactivate hardcoded user');
                return;
            }
            
            database.ref('users/' + userId).update({
                approved: false
            });
            showNotification('User deactivated');
        }
        
        // Delete user (admin function)
        function deleteUser(userId) {
            if (userId in hardcodedAccounts) {
                showNotification('Cannot delete hardcoded user', true);
                return;
            }
            
            if (confirm('Are you sure you want to delete this user?')) {
                database.ref('users/' + userId).remove();
                showNotification('User deleted');
            }
        }
        
        // Logout function
        function logout() {
            if (currentUser) {
                // Update user status to offline
                if (currentUser.id in hardcodedAccounts) {
                    // For hardcoded users
                    hardcodedAccounts[currentUser.id].status = "offline";
                } else {
                    // For Firebase users
                    database.ref('users/' + currentUser.id).update({
                        status: 'offline'
                    });
                }
                
                currentUser = null;
            }
            showView('login');
        }
        
        // Initialize the app
        function initApp() {
            initDatabase();
            showView('login');
            
            // Event listeners
            loginBtn.addEventListener('click', () => {
                login(loginUsername.value, loginPassword.value);
            });
            
            signupSwitchBtn.addEventListener('click', () => {
                showView('signup');
            });
            
            backToLoginBtn.addEventListener('click', () => {
                showView('login');
            });
            
            signupBtn.addEventListener('click', () => {
                if (signupPassword.value !== signupConfirm.value) {
                    signupMessage.textContent = 'Passwords do not match';
                    signupMessage.style.color = '#F44336';
                    return;
                }
                signup(signupUsername.value, signupPassword.value);
            });
            
            logoutBtn.addEventListener('click', logout);
            adminLogoutBtn.addEventListener('click', logout);
            
            backToDashboardBtn.addEventListener('click', () => {
                showView('dashboard');
            });
            
            backFromCallBtn.addEventListener('click', () => {
                showView('dashboard');
            });
            
            sendMessageBtn.addEventListener('click', sendMessage);
            
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            createUserBtn.addEventListener('click', createUser);
        }
        
        // Global functions for inline event handlers
        window.startChat = startChat;
        window.startCall = startCall;
        window.approveUser = approveUser;
        window.deactivateUser = deactivateUser;
        window.deleteUser = deleteUser;
        
        // Initialize the app when the page loads
        window.addEventListener('load', initApp);
    </script>
</body>
</html>